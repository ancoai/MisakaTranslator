name: CI

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  build:
    # 千万不要再用 windows-latest，固定住 2022 的环境
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          # 装个 8.0 SDK，能编 net7 + net472，向下兼容
          dotnet-version: 8.0.x

      - name: Install Windows 10 SDK 10.0.22621 + UWP VC
        shell: pwsh
        run: |
          Write-Host "Installing Windows 10 SDK 22621 + UWP VC components..."
          $installer = "C:\Program Files (x86)\Microsoft Visual Studio\Installer\setup.exe"

          & $installer modify `
            --installPath "C:\Program Files\Microsoft Visual Studio\2022\Enterprise" `
            --add Microsoft.VisualStudio.Component.Windows10SDK.22621 `
            --add Microsoft.VisualStudio.ComponentGroup.UWP.VC `
            --quiet --norestart --nocache

          if ($LASTEXITCODE -ne 0) {
            Write-Error "VS component install failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

          Write-Host "Windows SDK and UWP VC components installed."

      - name: Build solution (Release)
        shell: pwsh
        run: |
          dotnet build .\MisakaTranslator.sln -c Release -m:1

      - name: Upload WPF output
        uses: actions/upload-artifact@v4
        with:
          name: MisakaTranslator-WPF-Release
          path: MisakaTranslator-WPF/bin/Release
