name: CI-Build-and-Release

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      # ⭐ 最关键：安装 Windows 10 SDK 到真正存在的 VS Community 路径
      - name: Install Windows 10 SDK into VS Community
        shell: pwsh
        run: |
          Write-Host "Installing Windows 10 SDK..."
          $vsInstaller = "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vs_installer.exe"
          & $vsInstaller modify `
            --installPath "C:\Program Files\Microsoft Visual Studio\2022\Community" `
            --add Microsoft.VisualStudio.Component.Windows10SDK.22621 `
            --add Microsoft.VisualStudio.ComponentGroup.UWP.VC `
            --quiet --norestart
          Write-Host "SDK installation done."

      # Restore
      - run: dotnet restore

      # Build
      - run: dotnet build --configuration Release

      # Publish
      - run: dotnet publish MisakaTranslator-WPF/MisakaTranslator-WPF.csproj -c Release -r win-x64 --self-contained false -o publish/win-x64

      # Upload artifact
      - uses: actions/upload-artifact@v4
        with:
          name: MisakaTranslator-win-x64
          path: publish/win-x64/
